<geoengine-sidenav-header>Raster Kernel</geoengine-sidenav-header>

<geoengine-dialog-help>
    <p>
        The <i>Raster Kernel</i> operator computes a rectangular kernel for a pixel and its neighborhood. The operator can be defined as a
        matrix kernel with weights or as specialized kernel types, where only the size is specified.
    </p>
    <p>You can find more information at <a href="https://docs.geoengine.io/operators/rasterkernel.html">docs.geoengine.io</a>.</p>
</geoengine-dialog-help>

<form [formGroup]="form" (ngSubmit)="add()" fxLayout="column" *ngIf="projectHasRasterLayers$ | async; else noDataInfo">
    <div fxFlex class="container">
        <geoengine-layer-selection [types]="RASTER_TYPE" formControlName="rasterLayer"></geoengine-layer-selection>
        <geoengine-dialog-section-heading title="Configuration" subtitle="Specify the operator"></geoengine-dialog-section-heading>

        <mat-form-field appearance="fill">
            <mat-label>Kernel Type</mat-label>
            <mat-select formControlName="kernelType">
                <mat-option value="convolution">Convolution</mat-option>
                <mat-option value="standardDeviation">Standard Deviation</mat-option>
            </mat-select>
        </mat-form-field>

        <ng-container [ngSwitch]="form.controls.kernelType.value">
            <ng-container *ngSwitchCase="'convolution'">
                <div class="matrix-controls">
                    <button mat-button color="primary" type="button" (click)="enlargeMatrix()">
                        <mat-icon>add_circle_outline</mat-icon>
                    </button>
                    <button mat-button color="primary" type="button" (click)="smallenMatrix()">
                        <mat-icon>remove_circle_outline</mat-icon>
                    </button>
                    <button mat-button color="primary" type="button" (click)="rotate90()">
                        <mat-icon>refresh</mat-icon>
                    </button>
                    <button mat-button color="primary" type="button" [matMenuTriggerFor]="matrixMenu">
                        <mat-icon>settings_suggest</mat-icon>
                    </button>
                    <mat-menu #matrixMenu="matMenu">
                        <button mat-menu-item (click)="presetSobel()">Sobel</button>
                        <button mat-menu-item (click)="presetGaussianBlur()">Gaussian blur 5x5</button>
                        <button mat-menu-item (click)="presetMean()">Mean 3x3</button>
                    </mat-menu>
                </div>
                <div class="matrix">
                    <table>
                        <tr *ngFor="let row of getMatrix(); index as r">
                            <td *ngFor="let value of row; index as c">
                                <mat-form-field appearance="fill">
                                    <input
                                        matInput
                                        type="number"
                                        [ngModel]="value"
                                        (ngModelChange)="setMatrixValue(r, c, $event)"
                                        [ngModelOptions]="{standalone: true}"
                                    />
                                </mat-form-field>
                            </td>
                        </tr>
                    </table>
                </div>
            </ng-container>
            <ng-container *ngSwitchCase="'standardDeviation'">
                <p>Dimensions</p>
                <div *ngIf="getDimensions() as dimensions" fxLayout="row" fxLayoutAlign="space-between center" fxLayoutGap="0.5rem">
                    <mat-form-field appearance="fill" fxFlex>
                        <mat-label>X</mat-label>
                        <input
                            matInput
                            type="number"
                            [ngModel]="dimensions[0]"
                            (ngModelChange)="setDimensionValue(0, $event)"
                            [ngModelOptions]="{standalone: true}"
                        />
                    </mat-form-field>
                    <span>x</span>
                    <mat-form-field appearance="fill" fxFlex>
                        <mat-label>Y</mat-label>
                        <input
                            matInput
                            type="number"
                            [ngModel]="dimensions[1]"
                            (ngModelChange)="setDimensionValue(1, $event)"
                            [ngModelOptions]="{standalone: true}"
                        />
                    </mat-form-field>
                </div>
            </ng-container>
        </ng-container>

        <p *ngIf="form.controls.kernel.errors as kernelError" class="error">
            <span *ngIf="kernelError?.emptyKernel">Dimensions must not be empty</span>
            <span *ngIf="kernelError?.kernelDimensionsNotOdd">Dimensions must be odd</span>
            <span *ngIf="kernelError?.kernelDimensionsNegative">Dimensions must be positive</span>
        </p>

        <geoengine-operator-output-name formControlName="name">
            <mat-error *ngIf="form.controls.name.errors?.required || form.controls.name.errors?.onlyWhitespace">
                The name must be non-empty.
            </mat-error>
        </geoengine-operator-output-name>

        <p *ngIf="lastError$ | async as lastError" class="error">{{ lastError }}</p>
    </div>
    <div class="actions">
        <button type="submit" mat-raised-button color="primary" [disabled]="form.invalid">Create</button>
    </div>
</form>

<ng-template #noDataInfo>
    <p class="no-rasters">
        no raster input available
        <br />
        <button mat-button *ngIf="dataListConfig" (click)="goToAddDataTab()">⇢ add some data ⇢</button>
    </p>
</ng-template>
