<div class="grid-container">
    <mat-grid-list cols="2" rowHeight="300px">
        @for (card of cards | async; track card) {
            <mat-grid-tile [colspan]="card.cols" [rowspan]="card.rows">
                <mat-card class="dashboard-card">
                    <mat-card-header>
                        <mat-card-title>
                            {{ card.title }}
                            <button mat-icon-button class="more-button" [matMenuTriggerFor]="menu" aria-label="Toggle menu">
                                <mat-icon>more_vert</mat-icon>
                            </button>
                            <mat-menu #menu="matMenu" xPosition="before">
                                <button mat-menu-item>Expand</button>
                                <button mat-menu-item>Remove</button>
                            </mat-menu>
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content class="dashboard-card-content">
                        <ng-template [cdkPortalOutlet]="card.content"></ng-template>
                    </mat-card-content>
                </mat-card>
            </mat-grid-tile>
        }
    </mat-grid-list>
</div>

<ng-template #welcome>
    <p>Welcome to the Environmental Indicators Dashboard!</p>
    <p>
        Here, you can analyze specific areas of interest by selecting an indicator and drawing the area directly on the map. To get started,
        please select an indicator. Then, simply draw your area of interest on the map and start the analysis.
    </p>
</ng-template>

<ng-template #indicator>
    <p>Please choose one of the following indicators:</p>
    <mat-form-field>
        <mat-label>Select Indicator</mat-label>
        <mat-select (selectionChange)="changeIndicator($event)">
            <mat-option *ngFor="let indicator of indicators" [value]="indicator">
                <b>{{ indicator.name }}:</b> {{ indicator.description }}
            </mat-option>
        </mat-select>
    </mat-form-field>
</ng-template>

<ng-template #inspect>
    <div class="map-container">
        <geoengine-map-container #map [grid]="false">
            <ng-container *ngIf="userService.getSessionTokenStream() | async as sessionToken">
                <ng-template ngFor let-layer [ngForOf]="layersReverse$ | async" [ngForTrackBy]="idFromLayer">
                    <ng-template [ngIf]="layer.layerType === 'vector'">
                        <geoengine-ol-vector-layer
                            [layerId]="layer.id"
                            [workflow]="layer.workflowId"
                            [symbology]="$any(layer.symbology)"
                            [isVisible]="layer.isVisible"
                            (mapRedraw)="map.layerForcesRedraw()"
                        ></geoengine-ol-vector-layer>
                    </ng-template>
                    <ng-template [ngIf]="layer.layerType === 'raster'">
                        <geoengine-ol-raster-layer
                            [layerId]="layer.id"
                            [workflow]="layer.workflowId"
                            [symbology]="$any(layer.symbology)"
                            [isVisible]="layer.isVisible"
                            [sessionToken]="sessionToken"
                            (mapRedraw)="map.layerForcesRedraw()"
                        ></geoengine-ol-raster-layer>
                    </ng-template>
                </ng-template>
            </ng-container>
        </geoengine-map-container>
    </div>
    <geoengine-legend *ngIf="dataSelectionService.rasterLayer | async as rasterLayer" [layer]="rasterLayer"></geoengine-legend>
    <mat-progress-bar class="loading-indicator" mode="query" *ngIf="dataSelectionService.rasterLayerLoading | async"></mat-progress-bar>
</ng-template>

<ng-template #select>
    <!-- two button for draw and reset -->
    <div>
        <button mat-raised-button color="accent" (click)="selectBox()" [disabled]="isSelectingBox$ | async">
            Select region on the map
        </button>
        <button mat-raised-button (click)="reset()">Reset</button>
    </div>

    <!-- time selector -->
    <geoengine-time-step-selector [timeSteps]="timeSteps" timeFormat="YYYY-MM"></geoengine-time-step-selector>

    <!-- analyze button -->
    <button mat-raised-button color="primary" (click)="analyze()" [disabled]="!selectedIndicator || !selectedBBox">Analyze</button>
</ng-template>

<ng-template #review>
    <!-- vega component -->
    @if (plotData$ | async; as plot) {
        <div class="chart-container">
            <geoengine-vega-viewer [width]="500" [height]="500" [chartData]="plot"></geoengine-vega-viewer>

            <p>
                The chart shows the distribution of values for the selected indicator within the area of interest. The x-axis represents the
                classes or values and the y-axis the amount of pixels with this value.
            </p>
        </div>
    } @else {
        <p>Please select an indicator and a region of interest.</p>
    }
    <mat-spinner color="accent" *ngIf="plotLoading$ | async"></mat-spinner>
</ng-template>
